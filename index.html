<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Interview Coder</title>
  <style>
    html {
      width: 100%;
      height: 100%;
      background: none;
    }

    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: rgba(25, 25, 25, 0.85);
      /* Darker, more modern semi-transparent background */
      font-family: 'Inter', 'SF Pro Display', Arial, sans-serif;
      overflow: hidden;
      position: relative;
      border-radius: 12px;
      /* More rounded corners */
      border: 1px solid rgba(100, 100, 100, 0.3);
      /* Subtle border */
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      /* Stronger shadow for depth */
    }

    /* Improved instruction banner */
    #instruction-banner {
      position: fixed;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(20, 20, 20, 0.9);
      color: #fff;
      padding: 10px 18px;
      font-size: 14px;
      border-radius: 8px;
      z-index: 9999;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: opacity 0.3s ease, transform 0.3s ease;
      user-select: none;
      border: 1px solid rgba(120, 120, 120, 0.2);
    }

    /* Response overlay */
    #response-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9000;
      opacity: 0;
      pointer-events: none;
      backdrop-filter: blur(5px);
      transition: opacity 0.3s ease;
      padding: 20px;
      box-sizing: border-box;
    }

    #response-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    #response-box {
      background: rgba(35, 35, 35, 0.95);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      padding: 20px;
      width: 100%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(0);
      transition: transform 0.3s, opacity 0.3s;
      margin: 10px auto;
      color: white;
      font-size: 14px;
      line-height: 1.5;
      position: relative;
    }

    #result-content {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      box-sizing: border-box;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(100, 100, 100, 0.2);
      max-height: calc(100vh - 180px);
      overflow-y: auto;
    }

    #result-content:empty {
      display: none;
    }

    /* Ensure code blocks are scrollable */
    #result-content pre {
      max-width: 100%;
      overflow-x: auto;
    }

    /* Code block improvements */
    .code-block-container pre code {
      background: rgba(30, 30, 30, 0.8) !important;
      padding: 15px !important;
      border-radius: 6px !important;
      position: relative;
      font-family: 'Fira Code', 'JetBrains Mono', Consolas, monospace !important;
      overflow-x: auto !important;
      white-space: pre !important;
    }

    /* Code block container improvements */
    .code-block-container {
      position: relative;
      margin: 1.5em 0;
      max-width: 100%;
      overflow: hidden;
      border-radius: 6px;
    }

    /* Ensure proper styling of pre/code in our containers */
    .code-block-container pre {
      margin-top: 0;
      margin-bottom: 0;
      padding-top: 30px; /* Add space for language tag */
    }

    /* Hide default language tag that comes with our highlighter */
    pre:before {
      display: none !important;
    }

    /* Position the language tag correctly */
    .code-language-tag {
      position: absolute;
      top: 0;
      left: 0;
      background: rgba(40, 40, 40, 0.9);
      color: #ccc;
      padding: 3px 10px;
      border-radius: 6px 0 6px 0;
      font-size: 12px;
      font-family: 'Fira Code', 'JetBrains Mono', Consolas, monospace;
      z-index: 5;
      border-right: 1px solid rgba(100, 100, 100, 0.3);
      border-bottom: 1px solid rgba(100, 100, 100, 0.3);
    }

    /* Enhanced scrollbar styles for code blocks */
    #result-content pre::-webkit-scrollbar {
      height: 10px;
      background: rgba(30, 30, 30, 0.5);
      border-radius: 5px;
    }

    #result-content pre::-webkit-scrollbar-thumb {
      background: rgba(100, 100, 100, 0.7);
      border-radius: 5px;
    }

    #result-content pre::-webkit-scrollbar-thumb:hover {
      background: rgba(120, 120, 120, 0.9);
    }

    /* Make long code lines wrap to be helpful on mobile */
    @media (max-width: 768px) {
      #result-content pre,
      code {
        white-space: pre-wrap !important;
      }
    }

    /* Scrollbar for result content */
    #result-content::-webkit-scrollbar {
      width: 10px;
      background: rgba(30, 30, 30, 0.5);
      border-radius: 5px;
    }

    #result-content::-webkit-scrollbar-thumb {
      background: rgba(100, 100, 100, 0.7);
      border-radius: 5px;
    }

    #result-content::-webkit-scrollbar-thumb:hover {
      background: rgba(120, 120, 120, 0.9);
    }

    /* Code block copy button */
    .copy-code-button {
      position: absolute;
      top: 5px;
      right: 5px;
      padding: 5px 8px;
      border-radius: 4px;
      background-color: rgba(60, 60, 60, 0.7);
      color: #ffffff;
      border: none;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.2s;
      z-index: 10;
    }

    pre:hover .copy-code-button {
      opacity: 1;
    }

    .copy-code-button:hover {
      background-color: rgba(80, 80, 80, 0.9);
    }

    .copy-code-button.copied {
      background-color: #4CAF50;
    }

    /* Markdown content table styling */
    #result-content table {
      border-collapse: collapse;
      width: 100%;
      margin: 15px 0;
      font-size: 0.9em;
    }

    #result-content th,
    #result-content td {
      padding: 8px 12px;
      border: 1px solid rgba(100, 100, 100, 0.3);
    }

    #result-content th {
      background-color: rgba(40, 40, 40, 0.8);
      text-align: left;
    }

    #result-content tr:nth-child(even) {
      background-color: rgba(40, 40, 40, 0.4);
    }

    /* Make content have more breathing room */
    #result-content h1,
    #result-content h2,
    #result-content h3 {
      margin-top: 24px;
      margin-bottom: 16px;
      font-weight: 600;
      line-height: 1.25;
    }

    #result-content h1 {
      font-size: 1.8em;
      border-bottom: 1px solid rgba(100, 100, 100, 0.3);
      padding-bottom: 8px;
    }

    #result-content h2 {
      font-size: 1.5em;
      border-bottom: 1px solid rgba(100, 100, 100, 0.3);
      padding-bottom: 6px;
    }

    #result-content h3 {
      font-size: 1.2em;
    }

    /* Improved list styling */
    #result-content ul,
    #result-content ol {
      padding-left: 2em;
      margin: 1em 0;
    }

    #result-content li {
      margin-bottom: 0.5em;
    }

    #result-content ol li {
      padding-left: 0.5em;
    }

    /* Blockquote styling */
    #result-content blockquote {
      border-left: 4px solid rgba(120, 120, 120, 0.5);
      padding-left: 1em;
      margin: 1em 0;
      color: rgba(255, 255, 255, 0.8);
      font-style: italic;
    }

    /* Link styling */
    #result-content a {
      color: #5e9eff;
      text-decoration: none;
      border-bottom: 1px dotted #5e9eff;
    }

    #result-content a:hover {
      text-decoration: none;
      border-bottom: 1px solid #5e9eff;
    }

    #response-box::-webkit-scrollbar {
      width: 8px;
    }

    #response-box::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }

    #response-box::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
    }

    pre {
      background: rgba(35, 35, 35, 0.95);
      color: #f0f0f0;
      padding: 16px;
      border-radius: 8px;
      white-space: pre;
      overflow-x: auto;
      margin: 1.2em 0;
      border: 1px solid rgba(100, 100, 100, 0.2);
      font-family: 'Fira Code', 'JetBrains Mono', Consolas, monospace;
      font-size: 0.9em;
    }

    code {
      font-family: 'Fira Code', 'JetBrains Mono', Consolas, monospace;
      background: rgba(60, 60, 60, 0.95);
      color: #fff;
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 0.9em;
    }

    #response-box p {
      margin: 0 0 12px 0;
    }

    #response-box p:last-child {
      margin-bottom: 0;
    }

    .error-message {
      color: #ff4d4d;
      background: rgba(255, 77, 77, 0.08);
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #ff4d4d;
      margin: 15px 0;
    }

    .warning-message {
      color: #ffcc33;
      background: rgba(255, 204, 51, 0.08);
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #ffcc33;
      margin: 15px 0;
    }

    /* Improved loading container with skeleton UI */
    .loading-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      padding: 20px;
      box-sizing: border-box;
    }
    
    /* Skeleton loading styles */
    .skeleton-section {
      width: 100%;
      margin-bottom: 30px;
      animation: pulse 1.5s infinite;
    }
    
    .skeleton-header {
      height: 28px;
      width: 50%;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 4px;
      margin-bottom: 20px;
    }
    
    .skeleton-text {
      height: 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      margin-bottom: 12px;
    }
    
    .skeleton-text.line-90 {
      width: 90%;
    }
    
    .skeleton-text.line-80 {
      width: 80%;
    }
    
    .skeleton-text.line-70 {
      width: 70%;
    }
    
    .skeleton-code {
      height: 120px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      margin: 20px 0;
    }
    
    @keyframes pulse {
      0% {
        opacity: 0.6;
      }
      50% {
        opacity: 0.8;
      }
      100% {
        opacity: 0.6;
      }
    }

    .model-badge {
      position: fixed;
      bottom: 12px;
      right: 12px;
      background: rgba(30, 30, 30, 0.8);
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      user-select: none;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      z-index: 8000;
      border: 1px solid rgba(100, 100, 100, 0.3);
    }

    .screenshot-notification {
      position: fixed;
      bottom: 50px;
      right: 12px;
      background: rgba(20, 130, 20, 0.9);
      color: #fff;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 9000;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      max-width: 400px;
      border: 1px solid rgba(120, 180, 120, 0.3);
    }

    .screenshot-notification.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .screenshot-notification .file-path {
      font-size: 11px;
      opacity: 0.8;
      word-break: break-all;
      margin-top: 5px;
    }

    /* Updated Notification styles */
    #notification-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100000;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }
    
    .notification {
      padding: 14px 20px;
      background-color: #4CAF50;
      color: white;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      word-break: break-word;
      border: 1px solid rgba(120, 180, 120, 0.3);
      pointer-events: auto;
      opacity: 0;
      transform: translateX(50px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    
    .notification.warning {
      background-color: #FF9800;
      border: 1px solid rgba(180, 130, 20, 0.3);
    }
    
    .notification.error {
      background-color: #F44336;
      border: 1px solid rgba(180, 70, 70, 0.3);
    }
    
    .notification.visible {
      opacity: 1;
      transform: translateX(0);
    }
    
    /* For making the window invisible during screen sharing */
    body.invisible-mode {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    body.invisible-mode:hover {
      opacity: 0.8;
    }

    /* New Horizontal Floating Toolbar at the top */
    #top-toolbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: linear-gradient(to bottom, rgba(35, 35, 35, 0.98), rgba(30, 30, 30, 0.95));
      border-bottom: 1px solid rgba(100, 100, 100, 0.3);
      padding: 8px 15px;
      /* Removed extra right padding since window controls are gone */
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 12px;
      z-index: 9500;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      -webkit-app-region: drag;
      border-radius: 12px 12px 0 0;
      box-sizing: border-box;
      height: 50px;
      cursor: move;
      /* Show move cursor on the toolbar */
    }

    /* Toolbar buttons */
    .toolbar-button {
      display: flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 6px;
      background: rgba(60, 60, 60, 0.7);
      color: white;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 13px;
      white-space: nowrap;
      -webkit-app-region: no-drag;
      /* Make buttons clickable */
      border: 1px solid rgba(80, 80, 80, 0.3);
    }

    .toolbar-button:hover {
      background: rgba(80, 80, 80, 0.9);
    }

    .toolbar-button .icon {
      font-size: 14px;
      margin-right: 8px;
      min-width: 14px;
      text-align: center;
    }

    .toolbar-button .shortcut {
      font-size: 10px;
      margin-left: 6px;
      background: rgba(40, 40, 40, 0.7);
      padding: 2px 5px;
      border-radius: 4px;
    }

    /* Window control buttons */
    .window-controls {
      display: none;
      /* Hide window controls - removing completely */
    }

    .window-control {
      display: none;
      /* Hide window controls - removing completely */
    }

    .close-btn,
    .minimize-btn,
    .maximize-btn {
      display: none;
      /* Hide window controls - removing completely */
    }

    /* Additional styles to completely hide any macOS window controls */
    :root {
      --electron-titlebar-height: 0;
    }

    .window-controls,
    .window-control,
    .close-btn,
    .minimize-btn,
    .maximize-btn,
    :host(.platform-darwin) .titlebar-button,
    :host(.platform-darwin) .titlebar-close,
    :host(.platform-darwin) .titlebar-minimize,
    :host(.platform-darwin) .titlebar-maximize,
    :host(.platform-darwin) .titlebar-fullscreen {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      width: 0 !important;
      height: 0 !important;
      position: absolute !important;
      left: -9999px !important;
      pointer-events: none !important;
    }

    /* Content container */
    #content-container {
      padding-top: 60px;
      width: 100%;
      height: calc(100% - 50px);
      box-sizing: border-box;
      position: relative;
    }

    /* Response overlay */
    #main-content {
      padding: 20px;
      margin: 60px auto 20px auto;
      max-width: 900px;
      color: #f0f0f0;
      position: relative;
      padding-bottom: 80px; /* Add extra padding at the bottom for the sticky buttons */
    }

    /* Make context action buttons sticky and more attractive */
    #context-actions {
      position: sticky;
      bottom: 0;
      background: rgba(35, 35, 35, 0.95);
      padding: 15px;
      margin-top: 30px;
      text-align: center;
      z-index: 100;
      border-top: 1px solid rgba(100, 100, 100, 0.3);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      box-shadow: 0 -5px 10px rgba(0, 0, 0, 0.2);
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    /* Improved button styling for context actions */
    #context-actions .toolbar-button {
      padding: 8px 15px;
      border-radius: 8px;
      background: rgba(50, 50, 50, 0.8);
      transition: all 0.2s ease;
      border: 1px solid rgba(100, 100, 100, 0.4);
    }

    #context-actions .toolbar-button:hover {
      background: rgba(70, 70, 70, 0.9);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    #btn-add-context {
      background: rgba(40, 90, 40, 0.6) !important;
    }

    #btn-add-context:hover {
      background: rgba(50, 120, 50, 0.8) !important;
    }

    #btn-report-error {
      background: rgba(90, 40, 40, 0.6) !important;
    }

    #btn-report-error:hover {
      background: rgba(120, 50, 50, 0.8) !important;
    }
  </style>
</head>

<body>
  <!-- New horizontal floating toolbar at the top -->
  <div id="top-toolbar">
    <div class="toolbar-button" id="btn-toggle-visibility" title="Show/Hide (Cmd/Ctrl+B)">
      <span class="icon">👁️</span>
      <span>Show/Hide</span>
      <span class="shortcut" id="toggle-shortcut">⌘ B</span>
    </div>

    <div class="toolbar-button" id="btn-process" title="Process Screenshots (Cmd/Ctrl+Enter)">
      <span class="icon">📸</span>
      <span>Process Images</span>
      <span class="shortcut" id="process-shortcut">⌘ ↵</span>
    </div>

    <div class="toolbar-button" id="btn-auto-screenshot" title="Screenshot & Process (Cmd/Ctrl+H)">
      <span class="icon">📷</span>
      <span>Auto Screenshot</span>
      <span class="shortcut">⌘ H</span>
    </div>

    <div class="toolbar-button" id="btn-reset" title="Reset (Cmd/Ctrl+R)">
      <span class="icon">🔄</span>
      <span>Start Over</span>
      <span class="shortcut" id="reset-shortcut">⌘ R</span>
    </div>

    <div class="toolbar-button" id="btn-settings" title="Settings (Cmd/Ctrl+,)">
      <span class="icon">⚙️</span>
      <span>Settings</span>
      <span class="shortcut">⌘ ,</span>
    </div>
  </div>

  <!-- Content container to separate from toolbar -->
  <div id="content-container">
    <div id="instruction-banner"></div>

    <div id="main-content">
      <!-- Loading skeleton -->
      <div id="loading-content" class="loading-container" style="display: none;">
        <!-- Section 1: Analyzing the Problem -->
        <div class="skeleton-section">
          <div class="skeleton-header"></div>
          <div class="skeleton-text line-90"></div>
          <div class="skeleton-text line-80"></div>
          <div class="skeleton-text line-90"></div>
        </div>
        
        <!-- Section 2: My thoughts -->
        <div class="skeleton-section">
          <div class="skeleton-header"></div>
          <div class="skeleton-text line-90"></div>
          <div class="skeleton-text line-80"></div>
          <div class="skeleton-code"></div>
          <div class="skeleton-text line-70"></div>
        </div>
        
        <!-- Section 3: Complexity -->
        <div class="skeleton-section">
          <div class="skeleton-header"></div>
          <div class="skeleton-text line-80"></div>
          <div class="skeleton-text line-90"></div>
        </div>
      </div>

      <!-- Result content -->
      <div id="result-content"></div>

      <!-- Continue with context button section -->
      <!-- <div id="context-actions" style="display: none;">
        <div class="toolbar-button" id="btn-add-context">
          <span class="icon">📷</span>
          <span>Add screenshot to continue</span>
        </div>
        <div class="toolbar-button" id="btn-report-error">
          <span class="icon">🔄</span>
          <span>Report error in solution</span>
        </div>
      </div> -->
    </div>

    <div id="model-badge" class="model-badge"></div>

    <div id="notification-container"></div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    
    // Import remark and related packages
    let remark = null;
    let remarkGfm = null;
    let remarkHtml = null;
    let remarkProcessor = null;
    
    try {
      remark = require('remark');
      remarkGfm = require('remark-gfm');
      remarkHtml = require('remark-html');
      
      // Initialize remark processor
      remarkProcessor = remark()
        .use(remarkGfm)  // Add GitHub Flavored Markdown support
        .use(remarkHtml, {
          sanitize: false  // Allow HTML in the markdown
        });
        
      console.log("Remark initialized successfully");
    } catch (e) {
      console.error("Error initializing Remark:", e.message);
    }

    // Detect platform for correct key labels
    const isMac = navigator.platform.includes('Mac');
    const modifierKey = isMac ? 'Command' : 'Ctrl';

    // Application state
    let isWindowVisible = true;
    let debugMode = true; // Set to true for debugging

    // Toggle window visibility
    function toggleWindowVisibility() {
      // Simply notify main process about the visibility toggle request
      // Let main process handle the actual hiding/showing
      ipcRenderer.send('toggle-visibility');
      
      // Local state will be updated when we receive the update-visibility event
    }

    // Listen for main process messages
    ipcRenderer.on('update-instruction', (event, instruction) => {
      const banner = document.getElementById('instruction-banner');
      banner.textContent = instruction;
      banner.style.opacity = '1';
    });

    ipcRenderer.on('hide-instruction', () => {
      const banner = document.getElementById('instruction-banner');
      banner.style.opacity = '0';
    });

    ipcRenderer.on('update-visibility', (event, isVisible) => {
      isWindowVisible = isVisible;
      document.body.classList.toggle('invisible-mode', !isWindowVisible);
    });

    ipcRenderer.on('notification', (event, data) => {
      showNotification(data.body, data.title.toLowerCase().includes('error') ? 'error' : null);
    });

    ipcRenderer.on('warning', (event, message) => {
      showNotification(message, 'warning');
    });

    ipcRenderer.on('error', (event, message) => {
      showNotification(message, 'error');
    });

    ipcRenderer.on('loading', (event, isLoading) => {
      document.getElementById('loading-content').style.display = isLoading ? 'flex' : 'none';
      document.getElementById('result-content').style.display = isLoading ? 'none' : 'block';
      
      // Show/hide context actions when not loading
      document.getElementById('context-actions').style.display = isLoading ? 'none' : 'flex';
    });

    ipcRenderer.on('analysis-result', async (event, markdown) => {
      const html = await processMarkdown(markdown);
      document.getElementById('result-content').innerHTML = html;
      
      // Show context actions 
      document.getElementById('context-actions').style.display = 'flex';
      
      // Setup code copy buttons after content is added
      setupCodeCopyButtons();
      
      // Scroll to top
      window.scrollTo(0, 0);
    });

    // Setup for streaming results
    ipcRenderer.on('stream-start', () => {
      document.getElementById('result-content').innerHTML = '';
      document.getElementById('context-actions').style.display = 'none';
    });

    // Track current markdown accumulation state for improved streaming
    let streamBuffer = '';
    let codeBlockType = null;
    let insideCodeBlock = false;

    ipcRenderer.on('stream-chunk', async (event, chunk) => {
      try {
        // Add chunk to buffer
        streamBuffer += chunk;

        // Process the full accumulated text to ensure proper markdown rendering
        const html = await processMarkdown(streamBuffer);
        document.getElementById('result-content').innerHTML = html;

        // Setup code copy buttons
        setupCodeCopyButtons();

        // Auto-scroll to the bottom if user is already at the bottom
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
          window.scrollTo(0, document.body.scrollHeight);
        }
      } catch (error) {
        console.error("Error processing stream chunk:", error);
        // Display error but continue operation
        document.getElementById('result-content').innerHTML += `<p class="error-message">Error rendering chunk: ${error.message}</p>`;
      }
    });

    ipcRenderer.on('stream-update', async (event, fullText) => {
      // Replace the content with the full updated text (better for Gemini streaming)
      try {
        console.log("Received stream update, length:", fullText.length);
        // Update the stream buffer
        streamBuffer = fullText;

        // If the text is empty, don't process it
        if (!fullText || fullText.trim() === '') {
          return;
        }

        const html = await processMarkdown(fullText);
        document.getElementById('result-content').innerHTML = html;

        // Setup code copy buttons after content is updated
        setupCodeCopyButtons();

        // Auto-scroll to the bottom if user is already at the bottom
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
          window.scrollTo(0, document.body.scrollHeight);
        }
      } catch (error) {
        console.error("Error processing stream update:", error);
        // Provide better error visualization
        document.getElementById('result-content').innerHTML = `
          <p class="error-message">Error rendering content: ${error.message}</p>
          <pre>${fullText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
        `;
      }
    });

    ipcRenderer.on('stream-end', () => {
      // Streaming is complete, reset buffer
      console.log("Stream ended");
      streamBuffer = '';
      
      // Make sure all code blocks have copy buttons
      setupCodeCopyButtons();
      
      // Show context actions when streaming is complete
      document.getElementById('context-actions').style.display = 'flex';
      
      // Hide instruction banner when streaming is complete
      const banner = document.getElementById('instruction-banner');
      banner.style.opacity = '0';
      
      // Add a small scroll to ensure visible buttons if needed
      const resultContent = document.getElementById('result-content');
      if (resultContent.scrollHeight > resultContent.clientHeight) {
        resultContent.scrollBy({top: 1, behavior: 'smooth'});
      }
    });

    ipcRenderer.on('clear-result', () => {
      document.getElementById('result-content').innerHTML = '';
      document.getElementById('context-actions').style.display = 'none';
    });

    // Update AI provider/model badge display
    ipcRenderer.on('model-changed', () => {
      updateModelBadge();
    });

    // Handle screen sharing detection
    ipcRenderer.on('screen-sharing-detected', () => {
      // Make the window nearly invisible
      isWindowVisible = false;
      document.body.classList.add('invisible-mode');

      // Show temporary notification
      showTemporaryNotification('Screen sharing detected - window hidden. Press ' + modifierKey + '+B to show.', 'warning');
    });

    // Screenshot notification
    ipcRenderer.on('screenshot-saved', (event, data) => {
      const { path, dimensions, isArea } = data;
      const notification = document.createElement('div');
      notification.className = 'screenshot-notification';

      notification.innerHTML = `
        <div><strong>${isArea ? 'Area' : 'Screen'} Screenshot Saved</strong></div>
        ${dimensions ? `<div>Size: ${dimensions.width}×${dimensions.height}px</div>` : ''}
        <div class="file-path">${path}</div>
      `;

      document.body.appendChild(notification);

      // Animate in
      setTimeout(() => {
        notification.classList.add('visible');
      }, 10);

      // Remove after a few seconds
      setTimeout(() => {
        notification.classList.remove('visible');
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 5000);
    });

    // Update the model badge with current settings
    async function updateModelBadge() {
      try {
        const settings = await ipcRenderer.invoke('get-current-settings');
        const badge = document.getElementById('model-badge');

        let providerName = '';
        switch (settings.aiProvider) {
          case 'openai': providerName = 'OpenAI'; break;
          case 'ollama': providerName = 'Ollama'; break;
          case 'gemini': providerName = 'Gemini'; break;
          default: providerName = settings.aiProvider;
        }

        badge.textContent = `${providerName}: ${settings.currentModel}`;
      } catch (error) {
        console.error('Error updating model badge:', error);
      }
    }

    // Process markdown content to HTML using Remark
    async function processMarkdown(markdown) {
      try {
        // Check if we have any content to process
        if (!markdown || markdown.trim() === '') {
          return '';
        }

        // Debug logging
        if (debugMode) {
          console.log("Processing markdown input:", markdown);
        } else {
          console.log("Processing markdown, length:", markdown.length);
        }

        // Pre-process the markdown for better rendering
        let processedMarkdown = markdown;
        
        // Ensure code blocks have proper spacing
        let html;
        
        if (remarkProcessor) {
          // Use Remark to process markdown
          try {
            const vFile = await remarkProcessor.process(processedMarkdown);
            html = String(vFile);
          } catch (remarkError) {
            console.error("Remark processing error:", remarkError);
            throw remarkError;
          }
        } else {
          // Convert inline code
          html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

          // Convert headers
          html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
          html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
          html = html.replace(/^# (.*$)/gm, '<h1>$1</h1>');

          // Convert bold and italic
          html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
          html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');

          // Convert links
          html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>');

          // Convert paragraphs (simple approach)
          html = html.replace(/\n\n/g, '</p><p>');
          html = '<p>' + html + '</p>';
        }

        // If debug mode is on, add raw markdown visibility
        if (debugMode) {
          return `
            <div style="background: rgba(0,0,0,0.8); padding: 10px; margin-bottom: 10px; border-radius: 5px;">
              <details>
                <summary style="cursor: pointer; color: #ffcc00;">Debug: Raw Markdown (Click to expand)</summary>
                <pre style="max-height: 200px; overflow: auto; background: #222; padding: 10px; margin-top: 10px;">${processedMarkdown.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
              </details>
            </div>
            ${html}
          `;
        }

        // Add copy buttons to code blocks and language tags
        const wrapper = document.createElement('div');
        wrapper.innerHTML = html;
        
        // Find all pre > code elements and wrap them with copy button and language tag
        wrapper.querySelectorAll('pre > code').forEach(codeBlock => {
          const pre = codeBlock.parentNode;
          const container = document.createElement('div');
          container.className = 'code-block-container';
          
          // Create copy button
          const copyButton = document.createElement('button');
          copyButton.className = 'copy-code-button';
          copyButton.textContent = 'Copy';
          
          // Extract language from class
          let language = '';
          if (codeBlock.className) {
            const langMatch = codeBlock.className.match(/language-(\w+)/);
            if (langMatch && langMatch[1]) {
              language = langMatch[1];
              
              // Create language tag
              const langTag = document.createElement('div');
              langTag.className = 'code-language-tag';
              langTag.textContent = language;
              container.appendChild(langTag);
            }
          }
          
          // Move the pre element into the container
          pre.parentNode.insertBefore(container, pre);
          container.appendChild(copyButton);
          container.appendChild(pre);
        });

        return wrapper.innerHTML;
      } catch (err) {
        console.error('Error processing markdown:', err, '\nInput was:', markdown.substring(0, 100) + '...');

        if (debugMode) {
          return `
            <p class="error-message">Error rendering content: ${err.message}</p>
            <details>
              <summary style="cursor: pointer; color: #ff4d4d;">Debug: Raw Markdown with Error</summary>
              <pre style="max-height: 400px; overflow: auto; background: #222; padding: 10px; margin-top: 10px;">${markdown.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
            </details>
          `;
        }

        // Fallback for errors - try to display raw markdown
        return `<p class="error-message">Error rendering content: ${err.message}</p><pre>${markdown.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>`;
      }
    }

    // Add copy code functionality
    function setupCodeCopyButtons() {
      try {
        // Find all copy buttons
        const copyButtons = document.querySelectorAll('.copy-code-button');
  
        if (copyButtons.length === 0) {
          // No code blocks found yet
          return;
        }
  
        console.log(`Setting up ${copyButtons.length} code copy buttons`);
  
        copyButtons.forEach(button => {
          // Skip if the button already has a listener (check for data attribute)
          if (button.getAttribute('data-has-listener') === 'true') {
            return;
          }
  
          // Add the click event listener
          button.addEventListener('click', function () {
            try {
              // Find the code element within the container
              const pre = this.nextElementSibling;
              if (!pre || !pre.tagName || pre.tagName.toLowerCase() !== 'pre') {
                console.error('No pre element found');
                return;
              }
              
              const codeElement = pre.querySelector('code');
              if (!codeElement) {
                console.error('No code element found');
                return;
              }
  
              let codeText = codeElement.textContent;
              
              // Make sure we have a string
              if (typeof codeText !== 'string') {
                codeText = String(codeText);
              }
  
              // Copy the code to clipboard
              navigator.clipboard.writeText(codeText).then(() => {
                // Visual feedback
                this.textContent = 'Copied!';
                this.classList.add('copied');
  
                // Reset after a short delay
                setTimeout(() => {
                  this.textContent = 'Copy';
                  this.classList.remove('copied');
                }, 2000);
              }).catch(err => {
                console.error('Failed to copy code: ', err);
                this.textContent = 'Error';
  
                setTimeout(() => {
                  this.textContent = 'Copy';
                }, 2000);
              });
            } catch (err) {
              console.error('Error in copy button handler:', err);
              // Try to recover
              this.textContent = 'Error';
              setTimeout(() => {
                this.textContent = 'Copy';
              }, 2000);
            }
          });
  
          // Mark the button as having a listener
          button.setAttribute('data-has-listener', 'true');
        });
      } catch (err) {
        console.error('Error setting up code copy buttons:', err);
      }
    }

    // Show notification
    function showNotification(message, type = null) {
      const container = document.getElementById('notification-container');
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.className = 'notification';
      
      if (type) {
        notification.classList.add(type);
      }
      
      container.appendChild(notification);
      
      // Trigger reflow to ensure animation works
      void notification.offsetWidth;
      notification.classList.add('visible');
      
      // Hide after 5 seconds
      setTimeout(() => {
        notification.classList.remove('visible');
        
        // Remove from DOM after animation completes
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 5000);
    }

    // Show temporary notification that disappears faster
    function showTemporaryNotification(message, type = null) {
      const container = document.getElementById('notification-container');
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.className = 'notification';
      
      if (type) {
        notification.classList.add(type);
      }
      
      container.appendChild(notification);
      
      // Trigger reflow to ensure animation works
      void notification.offsetWidth;
      notification.classList.add('visible');
      
      // Hide after 2 seconds (faster than regular notifications)
      setTimeout(() => {
        notification.classList.remove('visible');
        
        // Remove from DOM after animation completes
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 2000);
    }

    // Register for keyboard events to handle shortcuts
    document.addEventListener('keydown', (e) => {
      // Allow event to propagate to text fields
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        return;
      }

      // Don't process if some modifier keys are pressed (to avoid conflicts)
      if (e.altKey) return;

      const ctrlOrCmd = isMac ? e.metaKey : e.ctrlKey;

      // If Ctrl/Cmd key is pressed
      if (ctrlOrCmd) {
        switch (e.key) {
          case 'b': // Toggle visibility
            toggleWindowVisibility();
            e.preventDefault();
            break;

          case 'Enter': // Process screenshots
            ipcRenderer.send('process-screenshots');
            e.preventDefault();
            break;

          case 'r': // Reset
            ipcRenderer.send('reset-process');
            e.preventDefault();
            break;

          case 'q': // Quit
            ipcRenderer.send('quit-app');
            e.preventDefault();
            break;
        }
      }
    });

    // Initialize
    updateModelBadge();

    // Setup toolbar button handlers
    document.getElementById('btn-toggle-visibility').addEventListener('click', () => {
      toggleWindowVisibility();
    });

    document.getElementById('btn-process').addEventListener('click', () => {
      ipcRenderer.send('process-screenshots');
    });

    document.getElementById('btn-auto-screenshot').addEventListener('click', () => {
      ipcRenderer.send('auto-screenshot');
    });

    document.getElementById('btn-reset').addEventListener('click', () => {
      ipcRenderer.send('reset-process');
    });

    document.getElementById('btn-settings').addEventListener('click', () => {
      ipcRenderer.send('open-settings');
    });

    // Handler for continuing with context (add screenshot)
    document.getElementById('btn-add-context').addEventListener('click', () => {
      ipcRenderer.send('add-context-screenshot');
    });

    // Handler for reporting error in solution
    document.getElementById('btn-report-error').addEventListener('click', () => {
      // Ask the user to describe the error
      const errorDescription = prompt('Please describe the error in the solution:');
      
      if (errorDescription && errorDescription.trim() !== '') {
        ipcRenderer.send('report-solution-error', errorDescription);
      }
    });

    // Update shortcut labels based on platform
    document.querySelectorAll('.shortcut').forEach(el => {
      const text = el.textContent;
      el.textContent = text.replace('⌘', isMac ? '⌘' : 'Ctrl');
    });
  </script>
</body>

</html>