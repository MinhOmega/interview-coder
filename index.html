<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Interview Coder</title>
  <style>
    html {
      width: 100%;
      height: 100%;
      background: none;
    }

    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: rgba(25, 25, 25, 0.85);
      /* Darker, more modern semi-transparent background */
      font-family: 'Inter', 'SF Pro Display', Arial, sans-serif;
      overflow: hidden;
      position: relative;
      border-radius: 12px;
      /* More rounded corners */
      border: 1px solid rgba(100, 100, 100, 0.3);
      /* Subtle border */
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      /* Stronger shadow for depth */
    }

    /* Improved instruction banner */
    #instruction-banner {
      position: fixed;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(20, 20, 20, 0.9);
      color: #fff;
      padding: 10px 18px;
      font-size: 14px;
      border-radius: 8px;
      z-index: 9999;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: opacity 0.3s ease, transform 0.3s ease;
      user-select: none;
      border: 1px solid rgba(120, 120, 120, 0.2);
    }

    /* Response overlay */
    #response-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9000;
      opacity: 0;
      pointer-events: none;
      backdrop-filter: blur(5px);
      transition: opacity 0.3s ease;
      padding: 20px;
      box-sizing: border-box;
    }

    #response-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    #response-box {
      background: rgba(35, 35, 35, 0.95);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      padding: 20px;
      width: 100%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(0);
      transition: transform 0.3s, opacity 0.3s;
      margin: 10px auto;
      color: white;
      font-size: 14px;
      line-height: 1.5;
      position: relative;
    }

    #result-content {
      width: 100%;
      max-height: 70vh;
      overflow-y: auto;
      padding-right: 10px;
    }

    #result-content pre {
      background: rgba(30, 30, 30, 0.8);
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    #response-box::-webkit-scrollbar {
      width: 8px;
    }

    #response-box::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }

    #response-box::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
    }

    pre {
      background: rgba(35, 35, 35, 0.95);
      color: #f0f0f0;
      padding: 16px;
      border-radius: 8px;
      white-space: pre;
      overflow-x: auto;
      margin: 1.2em 0;
      border: 1px solid rgba(100, 100, 100, 0.2);
      font-family: 'Fira Code', 'JetBrains Mono', Consolas, monospace;
      font-size: 0.9em;
    }

    code {
      font-family: 'Fira Code', 'JetBrains Mono', Consolas, monospace;
      background: rgba(60, 60, 60, 0.95);
      color: #fff;
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 0.9em;
    }

    #response-box p {
      margin: 0 0 12px 0;
    }

    #response-box p:last-child {
      margin-bottom: 0;
    }

    .error-message {
      color: #ff4d4d;
      background: rgba(255, 77, 77, 0.08);
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #ff4d4d;
      margin: 15px 0;
    }

    .warning-message {
      color: #ffcc33;
      background: rgba(255, 204, 51, 0.08);
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #ffcc33;
      margin: 15px 0;
    }

    /* Loading indicator */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top-color: #5e9eff;
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .model-badge {
      position: fixed;
      bottom: 12px;
      right: 12px;
      background: rgba(30, 30, 30, 0.8);
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      user-select: none;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      z-index: 8000;
      border: 1px solid rgba(100, 100, 100, 0.3);
    }

    .screenshot-notification {
      position: fixed;
      bottom: 50px;
      right: 12px;
      background: rgba(20, 130, 20, 0.9);
      color: #fff;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 9000;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      max-width: 400px;
      border: 1px solid rgba(120, 180, 120, 0.3);
    }

    .screenshot-notification.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .screenshot-notification .file-path {
      font-size: 11px;
      opacity: 0.8;
      word-break: break-all;
      margin-top: 5px;
    }

    #notification {
      position: fixed;
      bottom: 20px;
      left: 20px;
      padding: 14px 20px;
      background-color: #4CAF50;
      color: white;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
      max-width: 400px;
      word-break: break-word;
      border: 1px solid rgba(120, 180, 120, 0.3);
    }

    #notification.warning {
      background-color: #FF9800;
      border: 1px solid rgba(180, 130, 20, 0.3);
    }

    #notification.error {
      background-color: #F44336;
      border: 1px solid rgba(180, 70, 70, 0.3);
    }

    #notification.visible {
      opacity: 1;
    }

    /* For making the window invisible during screen sharing */
    body.invisible-mode {
      opacity: 0.05;
      transition: opacity 0.3s ease;
    }

    body.invisible-mode:hover {
      opacity: 0.8;
    }

    /* New Horizontal Floating Toolbar at the top */
    #top-toolbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: linear-gradient(to bottom, rgba(35, 35, 35, 0.98), rgba(30, 30, 30, 0.95));
      border-bottom: 1px solid rgba(100, 100, 100, 0.3);
      padding: 8px 15px; /* Removed extra right padding since window controls are gone */
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 12px;
      z-index: 9500;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      -webkit-app-region: drag;
      border-radius: 12px 12px 0 0;
      box-sizing: border-box;
      height: 50px;
      cursor: move; /* Show move cursor on the toolbar */
    }

    /* Toolbar buttons */
    .toolbar-button {
      display: flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 6px;
      background: rgba(60, 60, 60, 0.7);
      color: white;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 13px;
      white-space: nowrap;
      -webkit-app-region: no-drag;
      /* Make buttons clickable */
      border: 1px solid rgba(80, 80, 80, 0.3);
    }

    .toolbar-button:hover {
      background: rgba(80, 80, 80, 0.9);
    }

    .toolbar-button .icon {
      font-size: 14px;
      margin-right: 8px;
      min-width: 14px;
      text-align: center;
    }

    .toolbar-button .shortcut {
      font-size: 10px;
      margin-left: 6px;
      background: rgba(40, 40, 40, 0.7);
      padding: 2px 5px;
      border-radius: 4px;
    }

    /* Window control buttons */
    .window-controls {
      display: none; /* Hide window controls - removing completely */
    }

    .window-control {
      display: none; /* Hide window controls - removing completely */
    }

    .close-btn, .minimize-btn, .maximize-btn {
      display: none; /* Hide window controls - removing completely */
    }

    /* Additional styles to completely hide any macOS window controls */
    :root {
      --electron-titlebar-height: 0;
    }

    .window-controls,
    .window-control,
    .close-btn, 
    .minimize-btn, 
    .maximize-btn,
    :host(.platform-darwin) .titlebar-button,
    :host(.platform-darwin) .titlebar-close,
    :host(.platform-darwin) .titlebar-minimize,
    :host(.platform-darwin) .titlebar-maximize,
    :host(.platform-darwin) .titlebar-fullscreen {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      width: 0 !important;
      height: 0 !important;
      position: absolute !important;
      left: -9999px !important;
      pointer-events: none !important;
    }

    /* Content container */
    #content-container {
      padding-top: 60px;
      width: 100%;
      height: calc(100% - 50px);
      box-sizing: border-box;
      position: relative;
    }
  </style>
</head>

<body>
  <!-- New horizontal floating toolbar at the top -->
  <div id="top-toolbar">
    <div class="toolbar-button" id="btn-toggle-visibility" title="Show/Hide (Cmd/Ctrl+B)">
      <span class="icon">üëÅÔ∏è</span>
      <span>Show/Hide</span>
      <span class="shortcut" id="toggle-shortcut">‚åò B</span>
    </div>

    <div class="toolbar-button" id="btn-process" title="Process Screenshots (Cmd/Ctrl+Enter)">
      <span class="icon">üì∏</span>
      <span>Process Images</span>
      <span class="shortcut" id="process-shortcut">‚åò ‚Üµ</span>
    </div>

    <div class="toolbar-button" id="btn-auto-screenshot" title="Screenshot & Process (Cmd/Ctrl+H)">
      <span class="icon">üì∑</span>
      <span>Auto Screenshot</span>
      <span class="shortcut">‚åò H</span>
    </div>

    <div class="toolbar-button" id="btn-reset" title="Reset (Cmd/Ctrl+R)">
      <span class="icon">üîÑ</span>
      <span>Start Over</span>
      <span class="shortcut" id="reset-shortcut">‚åò R</span>
    </div>

    <div class="toolbar-button" id="btn-settings" title="Settings (Cmd/Ctrl+,)">
      <span class="icon">‚öôÔ∏è</span>
      <span>Settings</span>
      <span class="shortcut">‚åò ,</span>
    </div>
  </div>

  <!-- Content container to separate from toolbar -->
  <div id="content-container">
    <div id="instruction-banner"></div>

    <div id="response-overlay">
      <div id="response-box">
        <div id="loading-content" class="loading-container" style="display: none;">
          <div class="spinner"></div>
          <div>Processing screenshots...</div>
        </div>
        <div id="result-content"></div>
        <button id="close-response" style="position: absolute; top: 10px; right: 10px; background: rgba(60, 60, 60, 0.7); color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px;">Close</button>
      </div>
    </div>

    <div id="model-badge" class="model-badge"></div>

    <div id="notification"></div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    // Detect platform for correct key labels
    const isMac = navigator.platform.includes('Mac');
    const modifierKey = isMac ? 'Command' : 'Ctrl';

    // Application state
    let isWindowVisible = true;

    // Toggle window visibility
    function toggleWindowVisibility() {
      isWindowVisible = !isWindowVisible;
      document.body.classList.toggle('invisible-mode', !isWindowVisible);

      // Notify main process
      ipcRenderer.send('toggle-visibility', isWindowVisible);

      showTemporaryNotification(isWindowVisible ? 'Window visible' : 'Window hidden - hover to see');
    }

    // Listen for main process messages
    ipcRenderer.on('update-instruction', (event, instruction) => {
      const banner = document.getElementById('instruction-banner');
      banner.textContent = instruction;
      banner.style.opacity = '1';
    });

    ipcRenderer.on('hide-instruction', () => {
      const banner = document.getElementById('instruction-banner');
      banner.style.opacity = '0';
    });

    ipcRenderer.on('notification', (event, data) => {
      showNotification(data.body, data.title.toLowerCase().includes('error') ? 'error' : null);
    });

    ipcRenderer.on('warning', (event, message) => {
      showNotification(message, 'warning');
    });

    ipcRenderer.on('error', (event, message) => {
      showNotification(message, 'error');
    });

    ipcRenderer.on('loading', (event, isLoading) => {
      document.getElementById('loading-content').style.display = isLoading ? 'flex' : 'none';
      document.getElementById('result-content').style.display = isLoading ? 'none' : 'block';

      const overlay = document.getElementById('response-overlay');
      if (isLoading) {
        overlay.classList.add('visible');
      }
    });

    ipcRenderer.on('analysis-result', async (event, markdown) => {
      const html = await processMarkdown(markdown);
      document.getElementById('result-content').innerHTML = html;
      document.getElementById('response-overlay').classList.add('visible');
    });

    // Setup for streaming results
    ipcRenderer.on('stream-start', () => {
      document.getElementById('result-content').innerHTML = '';
      document.getElementById('response-overlay').classList.add('visible');
    });

    ipcRenderer.on('stream-chunk', async (event, chunk) => {
      // Append the new text
      const currentContent = document.getElementById('result-content').innerHTML;
      const chunkHtml = await processMarkdown(chunk);
      document.getElementById('result-content').innerHTML = currentContent + chunkHtml;
    });

    ipcRenderer.on('stream-update', async (event, fullText) => {
      // Replace the content with the full updated text (better for Gemini streaming)
      try {
        console.log("Received stream update, length:", fullText.length);
        const html = await processMarkdown(fullText);
        document.getElementById('result-content').innerHTML = html;
        // Scroll to the bottom to show latest content
        const responseBox = document.getElementById('response-box');
        responseBox.scrollTop = responseBox.scrollHeight;
      } catch (error) {
        console.error("Error processing stream update:", error);
        document.getElementById('result-content').innerHTML = '<p>Error rendering content</p><pre>' + fullText + '</pre>';
      }
    });

    ipcRenderer.on('stream-end', () => {
      // Streaming is complete, nothing special to do here
      console.log("Stream ended");
    });

    ipcRenderer.on('clear-result', () => {
      document.getElementById('result-content').innerHTML = '';
      document.getElementById('response-overlay').classList.remove('visible');
    });

    // Update AI provider/model badge display
    ipcRenderer.on('model-changed', () => {
      updateModelBadge();
    });

    // Handle screen sharing detection
    ipcRenderer.on('screen-sharing-detected', () => {
      // Make the window nearly invisible
      isWindowVisible = false;
      document.body.classList.add('invisible-mode');

      // Show temporary notification
      showTemporaryNotification('Screen sharing detected - window hidden. Press ' + modifierKey + '+B to show.', 'warning');
    });

    // Screenshot notification
    ipcRenderer.on('screenshot-saved', (event, data) => {
      const { path, dimensions, isArea } = data;
      const notification = document.createElement('div');
      notification.className = 'screenshot-notification';

      notification.innerHTML = `
        <div><strong>${isArea ? 'Area' : 'Screen'} Screenshot Saved</strong></div>
        ${dimensions ? `<div>Size: ${dimensions.width}√ó${dimensions.height}px</div>` : ''}
        <div class="file-path">${path}</div>
      `;

      document.body.appendChild(notification);

      // Animate in
      setTimeout(() => {
        notification.classList.add('visible');
      }, 10);

      // Remove after a few seconds
      setTimeout(() => {
        notification.classList.remove('visible');
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 5000);
    });

    // Update the model badge with current settings
    async function updateModelBadge() {
      try {
        const settings = await ipcRenderer.invoke('get-current-settings');
        const badge = document.getElementById('model-badge');

        let providerName = '';
        switch (settings.aiProvider) {
          case 'openai': providerName = 'OpenAI'; break;
          case 'ollama': providerName = 'Ollama'; break;
          case 'gemini': providerName = 'Gemini'; break;
          default: providerName = settings.aiProvider;
        }

        badge.textContent = `${providerName}: ${settings.currentModel}`;
      } catch (error) {
        console.error('Error updating model badge:', error);
      }
    }

    // Process markdown content to HTML
    async function processMarkdown(markdown) {
      try {
        // Simple markdown-to-HTML conversion without remark
        // Convert code blocks
        let html = markdown.replace(/```([a-z]*)([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>');
        
        // Convert inline code
        html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
        
        // Convert headers
        html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
        html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
        html = html.replace(/^# (.*$)/gm, '<h1>$1</h1>');
        
        // Convert bold and italic
        html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
        
        // Convert links
        html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>');
        
        // Convert paragraphs (simple approach)
        html = html.replace(/\n\n/g, '</p><p>');
        html = '<p>' + html + '</p>';
        
        return html;
      } catch (err) {
        console.error('Error processing markdown:', err);
        return `<p>Error rendering content: ${err.message}</p><pre>${markdown}</pre>`;
      }
    }

    // Show notification
    function showNotification(message, type = null) {
      const notification = document.getElementById('notification');
      notification.textContent = message;

      // Reset classes
      notification.className = '';
      notification.classList.add('notification');

      if (type) {
        notification.classList.add(type);
      }

      notification.classList.add('visible');

      // Hide after 5 seconds
      setTimeout(() => {
        notification.classList.remove('visible');
      }, 5000);
    }

    // Show temporary notification that disappears faster
    function showTemporaryNotification(message, type = null) {
      const notification = document.getElementById('notification');
      notification.textContent = message;

      // Reset classes
      notification.className = '';
      notification.classList.add('notification');

      if (type) {
        notification.classList.add(type);
      }

      notification.classList.add('visible');

      // Hide after 2 seconds (faster than regular notifications)
      setTimeout(() => {
        notification.classList.remove('visible');
      }, 2000);
    }

    // Register for keyboard events to handle shortcuts
    document.addEventListener('keydown', (e) => {
      // Allow event to propagate to text fields
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        return;
      }

      // Don't process if some modifier keys are pressed (to avoid conflicts)
      if (e.altKey) return;

      const ctrlOrCmd = isMac ? e.metaKey : e.ctrlKey;

      // If Ctrl/Cmd key is pressed
      if (ctrlOrCmd) {
        switch (e.key) {
          case 'b': // Toggle visibility
            toggleWindowVisibility();
            e.preventDefault();
            break;

          case 'Enter': // Process screenshots
            ipcRenderer.send('process-screenshots');
            e.preventDefault();
            break;

          case 'r': // Reset
            ipcRenderer.send('reset-process');
            e.preventDefault();
            break;

          case 'q': // Quit
            ipcRenderer.send('quit-app');
            e.preventDefault();
            break;
        }
      }
    });

    // Initialize
    updateModelBadge();

    // Setup toolbar button handlers
    document.getElementById('btn-toggle-visibility').addEventListener('click', () => {
      toggleWindowVisibility();
    });

    document.getElementById('btn-process').addEventListener('click', () => {
      ipcRenderer.send('process-screenshots');
    });

    document.getElementById('btn-auto-screenshot').addEventListener('click', () => {
      ipcRenderer.send('auto-screenshot');
    });

    document.getElementById('btn-reset').addEventListener('click', () => {
      ipcRenderer.send('reset-process');
    });

    document.getElementById('btn-settings').addEventListener('click', () => {
      ipcRenderer.send('open-settings');
    });

    // Close response overlay when close button is clicked
    document.getElementById('close-response').addEventListener('click', () => {
      document.getElementById('response-overlay').classList.remove('visible');
    });

    // Update shortcut labels based on platform
    document.querySelectorAll('.shortcut').forEach(el => {
      const text = el.textContent;
      el.textContent = text.replace('‚åò', isMac ? '‚åò' : 'Ctrl');
    });
  </script>
</body>

</html>